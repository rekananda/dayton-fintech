// Prisma schema for landing page + backoffice (based on variables/dummyData.ts)
// Target: PostgreSQL (recommend Neon/Supabase on Vercel)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Basic auth models for backoffice
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  passwordHash  String
  role          Role     @default(ADMIN)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Reverse relations for audit (optional)
  createdMenus        Menu[]                  @relation("MenuCreatedBy")
  updatedMenus        Menu[]                  @relation("MenuUpdatedBy")
  deletedMenus        Menu[]                  @relation("MenuDeletedBy")

  createdTimelines    Timeline[]              @relation("TimelineCreatedBy")
  updatedTimelines    Timeline[]              @relation("TimelineUpdatedBy")
  deletedTimelines    Timeline[]              @relation("TimelineDeletedBy")

  createdBusiness     BusinessModel[]         @relation("BusinessModelCreatedBy")
  updatedBusiness     BusinessModel[]         @relation("BusinessModelUpdatedBy")
  deletedBusiness     BusinessModel[]         @relation("BusinessModelDeletedBy")

  createdBmTables     BusinessModelTable[]    @relation("BmTableCreatedBy")
  updatedBmTables     BusinessModelTable[]    @relation("BmTableUpdatedBy")
  deletedBmTables     BusinessModelTable[]    @relation("BmTableDeletedBy")

  createdBmColumns    BusinessModelTableColumn[] @relation("BmColumnCreatedBy")
  updatedBmColumns    BusinessModelTableColumn[] @relation("BmColumnUpdatedBy")
  deletedBmColumns    BusinessModelTableColumn[] @relation("BmColumnDeletedBy")

  createdBmRows       BusinessModelTableRow[] @relation("BmRowCreatedBy")
  updatedBmRows       BusinessModelTableRow[] @relation("BmRowUpdatedBy")
  deletedBmRows       BusinessModelTableRow[] @relation("BmRowDeletedBy")

  createdBmCells      BusinessModelTableCell[] @relation("BmCellCreatedBy")
  updatedBmCells      BusinessModelTableCell[] @relation("BmCellUpdatedBy")
  deletedBmCells      BusinessModelTableCell[] @relation("BmCellDeletedBy")

  createdEvents       Event[]                 @relation("EventCreatedBy")
  updatedEvents       Event[]                 @relation("EventUpdatedBy")
  deletedEvents       Event[]                 @relation("EventDeletedBy")

  createdLegals       Legal[]                 @relation("LegalCreatedBy")
  updatedLegals       Legal[]                 @relation("LegalUpdatedBy")
  deletedLegals       Legal[]                 @relation("LegalDeletedBy")

  createdQnAs         QnA[]                   @relation("QnACreatedBy")
  updatedQnAs         QnA[]                   @relation("QnAUpdatedBy")
  deletedQnAs         QnA[]                   @relation("QnADeletedBy")

  createdConfigs      Config[]                @relation("ConfigCreatedBy")
  updatedConfigs      Config[]                @relation("ConfigUpdatedBy")
  deletedConfigs      Config[]                @relation("ConfigDeletedBy")
}

enum Role {
  ADMIN
}

// Landing page data

model Menu {
  id        Int      @id @default(autoincrement())
  label     String
  href      String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  createdBy String?
  updatedBy String?
  deletedBy String?
  createdByUser User?   @relation("MenuCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User?   @relation("MenuUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User?   @relation("MenuDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)
}

model Timeline {
  id          Int      @id @default(autoincrement())
  icon        String
  title       String
  description String
  color       String
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User? @relation("TimelineCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User? @relation("TimelineUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User? @relation("TimelineDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)
}

// Business Model can have nested tables with columns and rows.
// For MVP simplicity, we store tables as JSON to avoid many relational tables.
model BusinessModel {
  id          Int       @id @default(autoincrement())
  title       String
  description String
  tags        String[]  // e.g. ["MINGGUAN"]
  order       Int
  tables      BusinessModelTable[]
  tnc         String?   // terms & conditions or explanation
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User? @relation("BusinessModelCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User? @relation("BusinessModelUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User? @relation("BusinessModelDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)
}

// A Business Model can have many logical tables displayed on landing/backoffice.
model BusinessModelTable {
  id               Int                         @id @default(autoincrement())
  businessModelId  Int
  name             String                      // e.g. "Profit Sharing (Mingguan)"
  order            Int                         @default(1)
  columns          BusinessModelTableColumn[]
  rows             BusinessModelTableRow[]
  createdAt        DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  deletedAt        DateTime?
  createdBy        String?
  updatedBy        String?
  deletedBy        String?
  createdByUser    User?                       @relation("BmTableCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser    User?                       @relation("BmTableUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser    User?                       @relation("BmTableDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)

  businessModel    BusinessModel               @relation(fields: [businessModelId], references: [id], onDelete: Cascade)
}

// Table columns are dynamic per table (e.g., profit/calculation OR level/commission)
model BusinessModelTableColumn {
  id          Int                  @id @default(autoincrement())
  tableId     Int
  key         String               // machine key, e.g. "profit", "calculation"
  label       String               // human label
  order       Int                  @default(1)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User?              @relation("BmColumnCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User?              @relation("BmColumnUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User?              @relation("BmColumnDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)

  table       BusinessModelTable   @relation(fields: [tableId], references: [id], onDelete: Cascade)
  cells       BusinessModelTableCell[]
}

// Table rows are ordered records; cells store per-column values.
model BusinessModelTableRow {
  id          Int                  @id @default(autoincrement())
  tableId     Int
  order       Int                  @default(1)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User?              @relation("BmRowCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User?              @relation("BmRowUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User?              @relation("BmRowDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)

  table       BusinessModelTable   @relation(fields: [tableId], references: [id], onDelete: Cascade)
  cells       BusinessModelTableCell[]
}

// Cell stores the value for a given (row x column)
model BusinessModelTableCell {
  id          Int                        @id @default(autoincrement())
  rowId       Int
  columnId    Int
  value       String                     // store as text; UI can format (e.g., "$200", "5%")
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User?                    @relation("BmCellCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User?                    @relation("BmCellUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User?                    @relation("BmCellDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)

  row         BusinessModelTableRow      @relation(fields: [rowId], references: [id], onDelete: Cascade)
  column      BusinessModelTableColumn   @relation(fields: [columnId], references: [id], onDelete: Cascade)

  @@unique([rowId, columnId]) // one value per (row, column)
}

model Event {
  id          Int      @id @default(autoincrement())
  imageUrl    String   // store URL (GDrive/Cloudinary/etc.)
  dateText    String   // keep as localized text e.g. "15 Maret 2024"
  title       String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User? @relation("EventCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User? @relation("EventUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User? @relation("EventDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)
}

model Legal {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User? @relation("LegalCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User? @relation("LegalUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User? @relation("LegalDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)
}

model QnA {
  id        Int      @id @default(autoincrement())
  question  String
  answer    String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  createdBy String?
  updatedBy String?
  deletedBy String?
  createdByUser User? @relation("QnACreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User? @relation("QnAUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User? @relation("QnADeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)
}

// Key-Value configuration storage (e.g., WhatsApp number, email, etc.)
model Config {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  createdBy   String?
  updatedBy   String?
  deletedBy   String?
  createdByUser User? @relation("ConfigCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User? @relation("ConfigUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  deletedByUser User? @relation("ConfigDeletedBy", fields: [deletedBy], references: [id], onDelete: SetNull)
}


